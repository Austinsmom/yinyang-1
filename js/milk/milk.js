var Template,TemplateLoop,TemplateText,TemplateVar,href,milk,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);d.prototype=b.prototype;a.prototype=new d;a.__super__=b.prototype;return a};milk={guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;b=Math.random()*16|0;c=a==="x"?b:b&3|8;return c.toString(16)}).toUpperCase()}};Template=function(){function a(a,b,c){this.parent=a!=null?a:null;this.value=b!=null?b:"";this.ignore=c!=null?c:!1;this.children=[]}a.values={meta:{},ajax:{},hsql:{}};a.placeholders={};a.setup=function(){return $("meta").each(function(b){$(this).attr("name")!=null&&(a.values.meta[$(this).attr("name").replace(/[^a-zA-Z0-9_]/g,"_")]=$(this).attr("content"));return typeof console!="undefined"&&console!==null?console.log(a.values):void 0})};a.ajax=function(a,b){var c=this;typeof console!="undefined"&&console!==null&&console.log("ajax request : "+b);return $.getJSON(b).success(function(b){c.setValue(a,b);return c.processPlaceholder(a)}).error(function(){return typeof console!="undefined"&&console!==null?console.log("ajax error"):void 0})};a.hsql=function(a,b){var c=this;typeof console!="undefined"&&console!==null&&console.log("hsql request : "+b);return $.getJSON("hsql.php?q="+b).success(function(b){typeof console!="undefined"&&console!==null&&console.log(b);c.setValue(a,b);return c.processPlaceholder(a)}).error(function(){return typeof console!="undefined"&&console!==null?console.log("hsql error"):void 0})};a.fetch=function(b){var c,d,e,f,g,h,i,j,k,l,m,n;m=b.match(/<meta.*? name="milk:[a-z][a-zA-Z0-9\.]+".*?>/gim);for(i=0,k=m.length;i<k;i++){e=m[i];f=$(e).attr("name").split(":")[1];c=$(e).attr("content");f.match(/^ajax/)?this.ajax(f,c):f.match(/^hsql/)&&this.hsql(f,c)}g=h=new a;n=b.split(/(<!--\{.+?\}-->|\#\{.+?\})/gim);for(j=0,l=n.length;j<l;j++){d=n[j];d!=null&&(g=g.add(d))}return h.display()};a.valueExists=function(b){var c,d,e,f;d=b.split(".");e=a.values;while(e!=null&&(c=d.shift()))e=(f=e[c])!=null?f:null;return e!=null};a.setValue=function(b,c){var d,e,f,g,h;e=b.split(".");f=e.pop();g=a.values;while(d=e.shift())g=(h=g[d])!=null?h:"";return g[f]=c};a.setValues=function(b){var c,d,e;e=[];for(c in b){if(!__hasProp.call(b,c))continue;d=b[c];e.push(a.values[c]=d)}return e};a.getValue=function(b){var c,d,e,f;d=b.split(".");e=a.values;while(c=d.shift())e=(f=e[c])!=null?f:"";return e};a.addPlaceholder=function(a,b){return this.placeholders[a]=b};a.processPlaceholder=function(a){if(this.placeholders[a]!=null){this.placeholders[a]();return delete this.placeholders[a]}};a.prototype.add=function(a){var b;b={pend:/<!--\{end\}-->/,more:/<!--\{more\}-->/,pvar:/<!--\{(@[a-zA-Z0-9_\.\#>=\[\]]+|[a-zA-Z][a-zA-Z0-9_\.]*)\}-->/,ivar:/\#\{(@[a-zA-Z0-9_\.\#>=\[\]]+|[a-zA-Z][a-zA-Z0-9_\.]*)\}/,loop:/<!--\{[a-zA-Z][a-zA-Z0-9_\.]* in (@[a-zA-Z0-9_\.\#>=\[\]]+|[a-zA-Z][a-zA-Z0-9_\.]*)\}-->/};if(a.match(b.pend)){this.ignore=!1;return this.parent}if(a.match(b.more)){this.ignore=!0;return this}return this.ignore?this:a.match(b.pvar)?this._add("child",new TemplateVar(this,a.replace(/<!--{|}-->/g,""),!0)):a.match(b.ivar)?this._add("self",new TemplateVar(this,a.replace(/\#\{|\}/g,""))):a.match(b.loop)?this._add("child",new TemplateLoop(this,a.replace(/<!--{|}-->/g,""))):this._add("self",new TemplateText(this,a))};a.prototype._add=function(a,b){this.children.push(b);switch(a){case"child":return b;case"self":return this}};a.prototype.display=function(a){var b;a==null&&(a={});return function(){var c,d,e,f;e=this.children;f=[];for(c=0,d=e.length;c<d;c++){b=e[c];f.push(b.display(a))}return f}.call(this).join("")};return a}();TemplateLoop=function(a){function b(){b.__super__.constructor.apply(this,arguments)}__extends(b,a);b.prototype.display=function(a){var b,c,d;this.placeholder_id=milk.guid();d=this.value.split(/\s+in\s+/),c=d[0],b=d[1];if(Template.valueExists(b))return this.displayLoop(a,c,b);if(b.match(/^(ajax|hsql)\./))return this.diaplayPlaceholder(a,c,b);typeof console!="undefined"&&console!==null&&console.log("Template value not found.");return""};b.prototype.displayLoop=function(a,b,c){var d,e,f,g,h;return function(){var i,j,k,l;k=Template.getValue(c);l=[];for(i=0,j=k.length;i<j;i++){e=k[i];l.push(function(){var c,i,j,k;j=this.children;k=[];for(c=0,i=j.length;c<i;c++){d=j[c];g={};for(f in a){h=a[f];g[f]=h}g[b]=e;k.push(d.display(g))}return k}.call(this).join(""))}return l}.call(this).join("")};b.prototype.diaplayPlaceholder=function(a,b,c){var d=this;Template.addPlaceholder(c,function(){var e;e=d.displayLoop(a,b,c);return $("#"+d.placeholder_id).before(e).remove()});return'<span class="loading" id="'+this.placeholder_id+'"></span>'};return b}(Template);TemplateVar=function(a){function b(){b.__super__.constructor.apply(this,arguments)}__extends(b,a);b.prototype.display=function(a){this.localValues=a;return this.value[0]==="@"?this.displayDom():this.displayVar()};b.prototype.displayDom=function(){return $(this.value.substring(1)).html()};b.prototype.displayVar=function(){return this.getLocalValue(this.value)||Template.getValue(this.value)};b.prototype.getLocalValue=function(a){var b,c,d,e;c=a.split(".");d=this.localValues;while(b=c.shift())d=(e=d[b])!=null?e:"";return d};return b}(Template);TemplateText=function(a){function b(){b.__super__.constructor.apply(this,arguments)}__extends(b,a);b.prototype.display=function(){return this.value};return b}(Template);Template.setup();href=$("link[rel=template]").attr("href");$.ajax({url:href,success:function(a){a=Template.fetch(a);return $("html").html(a.split(/(<html.*?>|<\/html>)/ig)[2])}});